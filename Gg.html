<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScrewStudio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg: #0a0a0c;
            --card: rgba(20, 20, 25, 0.95);
            --text: #e2e8f0;
            --accent: #6366f1;
            --border: rgba(255,255,255,0.1);
            --ui-zoom: 1;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body { 
            background-color: var(--bg); 
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text); 
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: none;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s ease;
        }

        /* --- LOADING SCREEN --- */
        #loader-screen {
            position: fixed; inset: 0; background: #050505; z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
            will-change: opacity;
        }
        .load-logo { font-size: 3rem; font-weight: 900; letter-spacing: -2px; text-transform: uppercase; will-change: transform, filter, opacity; }
        .load-studio { color: var(--accent); }
        
        /* 14 ANIMATIONS (4 ORIGINAL + 10 NEW) */
        .anim-spin { animation: spin 2s infinite linear; }
        .anim-bounce { animation: bounce 1s infinite alternate cubic-bezier(0.45, 0, 0.55, 1); }
        .anim-slide { animation: slide 2s infinite alternate ease-in-out; }
        .anim-3d { animation: threeD 3s infinite linear; perspective: 1000px; }
        
        /* NEW 10 ANIMATIONS */
        .anim-glitch { animation: glitch 0.3s infinite; }
        .anim-neon { animation: neon 1.5s infinite alternate; }
        .anim-float { animation: float 3s infinite ease-in-out; }
        .anim-zoom { animation: zoom 2s infinite alternate ease-in-out; }
        .anim-shake { animation: shake 0.5s infinite; }
        .anim-skew { animation: skew 1s infinite alternate; }
        .anim-rotate-x { animation: rotateX 2s infinite linear; }
        .anim-blur { animation: blurFade 2s infinite alternate; }
        .anim-pulse-ring { animation: pulseRing 1.5s infinite; }
        .anim-flip { animation: flipX 2s infinite; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-30px); } }
        @keyframes slide { from { transform: translateX(-50px); } to { transform: translateX(50px); } }
        @keyframes threeD { 0% { transform: rotateY(0deg); } 50% { transform: rotateY(180deg) scale(1.1); } 100% { transform: rotateY(360deg); } }
        
        @keyframes glitch {
            0% { transform: translate(0); text-shadow: -2px 0 #ff00c1, 2px 0 #00fff9; }
            25% { transform: translate(-2px, 2px); }
            50% { transform: translate(2px, -2px); text-shadow: 2px 0 #ff00c1, -2px 0 #00fff9; }
            75% { transform: translate(-2px, -2px); }
            100% { transform: translate(0); }
        }
        @keyframes neon { from { filter: drop-shadow(0 0 2px var(--accent)); } to { filter: drop-shadow(0 0 15px var(--accent)) drop-shadow(0 0 30px var(--accent)); } }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-20px) rotate(5deg); } }
        @keyframes zoom { from { transform: scale(0.8); opacity: 0.5; } to { transform: scale(1.2); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes skew { from { transform: skewX(-15deg); } to { transform: skewX(15deg); } }
        @keyframes rotateX { from { transform: rotateX(0deg); } to { transform: rotateX(360deg); } }
        @keyframes blurFade { from { filter: blur(0px); opacity: 1; } to { filter: blur(8px); opacity: 0.3; } }
        @keyframes pulseRing { 0% { transform: scale(1); text-shadow: 0 0 0 rgba(99, 102, 241, 0.7); } 70% { transform: scale(1.05); text-shadow: 0 0 20px rgba(99, 102, 241, 0); } 100% { transform: scale(1); } }
        @keyframes flipX { 0% { transform: perspective(400px) rotateX(0deg); } 50% { transform: perspective(400px) rotateX(180deg); } 100% { transform: perspective(400px) rotateX(360deg); } }

        .load-bar-container { width: 240px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 20px; overflow: hidden; }
        #load-bar-fill { width: 0%; height: 100%; background: var(--accent); transition: width 0.1s linear; }

        #ui-wrapper {
            transform: scale(var(--ui-zoom));
            transform-origin: top left;
            width: calc(100% / var(--ui-zoom));
            height: calc(100% / var(--ui-zoom));
            position: absolute;
            top: 0; left: 0;
            visibility: hidden;
            will-change: transform;
        }

        .floating-panel {
            position: absolute;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            border-radius: 12px;
            backdrop-filter: blur(15px);
            z-index: 10;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            will-change: transform, width, height;
        }

        .panel-header {
            padding: 10px;
            background: rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            user-select: none;
            cursor: move;
            touch-action: none;
        }

        .panel-content { padding: 15px; flex-grow: 1; overflow-y: auto; scrollbar-width: thin; }
        .minimized .panel-content { display: none; }
        .minimized { height: auto !important; }

        .btn-icon {
            width: 26px; height: 26px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.08);
            border-radius: 6px; font-size: 14px;
            transition: background 0.2s;
            cursor: pointer;
        }
        .btn-icon:hover { background: var(--accent); }

        .resize-handle {
            position: absolute; right: 0; bottom: 0; width: 15px; height: 15px;
            cursor: nwse-resize; background: linear-gradient(135deg, transparent 50%, var(--accent) 50%);
        }

        .fullscreen { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; border-radius: 0 !important; }

        input[type=range] { accent-color: var(--accent); cursor: pointer; }

        .fx-card {
            background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; margin-bottom: 6px;
            border: 1px solid var(--border);
        }

        .category-tab {
            padding: 4px 10px; font-size: 10px; background: rgba(255,255,255,0.05);
            border-radius: 6px; cursor: pointer; white-space: nowrap;
        }
        .category-tab.active { background: var(--accent); color: white; }

        #zoom-ctrl {
            position: fixed; bottom: 20px; left: 20px; z-index: 10000;
            background: var(--card); padding: 10px; border-radius: 20px;
            border: 1px solid var(--border); display: flex; align-items: center; gap: 10px;
        }

        video { width: 100%; height: 100%; object-fit: contain; background: black; will-change: transform; }
        
        .rename-input {
            background: rgba(0,0,0,0.5); border: 1px solid var(--accent); color: white;
            padding: 2px 8px; border-radius: 4px; font-size: 10px; outline: none; width: 150px;
        }

        .studio-text { color: var(--accent); transition: color 0.4s ease; }
        
        #progC { position: relative; }
        #progB { transition: width 0.1s linear; }

        .loop-active {
            background: var(--accent) !important;
            color: white !important;
            box-shadow: 0 0 10px var(--accent);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body id="mainBody">

<!-- SPLASH SCREEN -->
<div id="loader-screen">
    <div id="loader-logo" class="load-logo">
        Screw<span class="load-studio">Studio</span>
    </div>
    <div class="load-bar-container">
        <div id="load-bar-fill"></div>
    </div>
    <div id="load-text" class="text-[10px] mt-2 opacity-50 uppercase tracking-widest">Iniciando... 0%</div>
</div>

<div id="ui-wrapper">
    <!-- TOP CONTROL -->
    <div class="fixed top-4 left-0 w-full flex flex-col items-center gap-2 z-[1000] pointer-events-none">
        <div class="flex gap-3 pointer-events-auto bg-black/60 p-2 px-4 rounded-2xl backdrop-blur-xl border border-white/10 items-center">
            <div class="text-[11px] font-black tracking-tighter uppercase select-none">
                Screw<span class="studio-text">Studio</span>
            </div>
            <div class="w-[1px] h-4 bg-white/10"></div>
            <select id="themeSelector" class="bg-zinc-800 text-white text-[10px] rounded-lg p-2 outline-none border-none max-w-[150px]"></select>
            <button onclick="document.getElementById('customSettings').classList.toggle('hidden')" class="bg-zinc-700 text-white text-[10px] px-3 rounded-lg h-8">Estilo</button>
            <button onclick="toggleRenameUI()" class="bg-zinc-700 text-white text-[10px] px-3 rounded-lg h-8">Renomear</button>
            <div id="renameContainer" class="hidden flex items-center gap-2 px-2 bg-black/40 rounded-lg h-8">
                <input type="text" id="globalFileName" value="meu_remix" class="rename-input">
                <button onclick="toggleRenameUI()" class="text-[10px] text-green-400">Ok</button>
            </div>
        </div>

        <div id="customSettings" class="hidden pointer-events-auto bg-black/90 p-5 rounded-2xl flex flex-wrap gap-5 border border-white/10 shadow-2xl">
            <div class="flex flex-col items-center"><label class="text-[10px] mb-2 text-white">Fundo</label><input type="color" id="cBg" value="#0a0a0c"></div>
            <div class="flex flex-col items-center"><label class="text-[10px] mb-2 text-white">Painel</label><input type="color" id="cCard" value="#141419"></div>
            <div class="flex flex-col items-center"><label class="text-[10px] mb-2 text-white">Texto</label><input type="color" id="cText" value="#e2e8f0"></div>
            <div class="flex flex-col items-center"><label class="text-[10px] mb-2 text-white">Destaque</label><input type="color" id="cAccent" value="#6366f1"></div>
            <div class="flex flex-col items-center"><label class="text-[10px] mb-2 text-white">Imagem Fundo</label><input type="file" id="cImg" accept="image/*" class="w-32 text-[10px]"></div>
        </div>
    </div>

    <!-- VIDEO PANEL -->
    <div id="videoPanel" class="floating-panel hidden" style="top: 100px; left: 400px; width: 640px; height: 320px;" onmousedown="focusPanel('videoPanel')" ontouchstart="focusPanel('videoPanel')">
        <div class="panel-header">
            <div class="flex items-center gap-2 pointer-events-none">
                <span class="btn-icon">‚ú•</span>
                <span class="text-[10px] font-bold uppercase" id="fileNameDisp">Compara√ß√£o de V√≠deo</span>
            </div>
            <div class="flex gap-1 pointer-events-auto">
                <button onclick="minimizePanel('videoPanel')" class="btn-icon">_</button>
                <button onclick="toggleFS('videoPanel')" class="btn-icon">‚õ∂</button>
            </div>
        </div>
        <div class="panel-content flex p-0 overflow-hidden bg-black relative">
            <div class="flex-1 relative border-r border-white/10"><video id="rawVideo" muted playsinline></video></div>
            <div class="flex-1 relative">
                <video id="mainVideo" muted playsinline></video>
                <div id="reactionTarget" class="absolute inset-0 pointer-events-none"></div>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- PLAYER PANEL -->
    <div id="playerPanel" class="floating-panel" style="top: 100px; left: 20px; width: 340px;" onmousedown="focusPanel('playerPanel')" ontouchstart="focusPanel('playerPanel')">
        <div class="panel-header">
            <div class="flex items-center gap-2 pointer-events-none">
                <span class="btn-icon">‚ú•</span>
                <span class="text-[10px] font-bold uppercase">Painel de Controle</span>
            </div>
            <div class="flex gap-1 pointer-events-auto">
                <button onclick="minimizePanel('playerPanel')" class="btn-icon">_</button>
                <button onclick="toggleFS('playerPanel')" class="btn-icon">‚õ∂</button>
            </div>
        </div>
        <div class="panel-content">
            <canvas id="mainViz" class="w-full h-24 mb-4 bg-black/40 rounded-xl"></canvas>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="triggerUpload('audio')" class="py-2 bg-white/5 border border-white/10 rounded-xl text-[9px] font-bold uppercase">√Åudio</button>
                <button onclick="triggerUpload('video')" class="py-2 bg-white/5 border border-white/10 rounded-xl text-[9px] font-bold uppercase">V√≠deo</button>
            </div>
            <input type="file" id="mediaInput" class="hidden">
            <div class="flex justify-between text-[10px] font-mono mb-1"><span id="currT">0:00</span><span id="durT">0:00</span></div>
            <div id="progC" class="w-full h-3 bg-white/5 rounded-full mb-4 cursor-pointer overflow-hidden border border-white/5">
                <div id="progB" class="h-full w-0 bg-indigo-500"></div>
            </div>
            <div class="flex gap-2 mb-4">
                <button id="playBtn" disabled class="bg-indigo-600 flex-[2] py-2 rounded-lg text-xs font-bold uppercase">Play</button>
                <button id="loopBtn" disabled class="bg-white/10 w-12 rounded-lg flex items-center justify-center text-xs">‚àû</button>
                <button id="stopBtn" disabled class="bg-white/10 flex-1 py-2 rounded-lg text-xs font-bold uppercase">Stop</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <div class="p-2 bg-black/30 rounded-lg"><div class="flex justify-between text-[9px] mb-1"><span>TOM</span><span id="pitchV">0</span></div><input type="range" id="pitchS" min="-1200" max="1200" value="0" class="w-full"></div>
                <div class="p-2 bg-black/30 rounded-lg"><div class="flex justify-between text-[9px] mb-1"><span>VEL</span><span id="speedV">1.0</span></div><input type="range" id="speedS" min="0.5" max="2.0" step="0.01" value="1.0" class="w-full"></div>
            </div>
            <button id="downBtn" disabled class="w-full py-2 bg-white/5 border border-white/10 rounded-lg text-[9px] font-bold">SALVAR MIX (.WAV)</button>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- FX CABINET -->
    <div id="fxPanel" class="floating-panel" style="top: 100px; right: 20px; width: 320px; height: 450px;" onmousedown="focusPanel('fxPanel')" ontouchstart="focusPanel('fxPanel')">
        <div class="panel-header">
            <div class="flex items-center gap-2 pointer-events-none">
                <span class="btn-icon">‚ú•</span>
                <span class="text-[10px] font-bold uppercase">Efeitos Especiais</span>
            </div>
            <div class="flex gap-1 pointer-events-auto">
                <button onclick="minimizePanel('fxPanel')" class="btn-icon">_</button>
                <button onclick="toggleFS('fxPanel')" class="btn-icon">‚õ∂</button>
            </div>
        </div>
        <div class="px-3 pt-3 flex gap-2 overflow-x-auto no-scrollbar" id="fxCategories">
            <div class="category-tab active" data-cat="all">Todos</div>
            <div class="category-tab" data-cat="Dynamics">Dinamica</div>
            <div class="category-tab" data-cat="Filter">Filtros</div>
            <div class="category-tab" data-cat="Spatial">Espacial</div>
            <div class="category-tab" data-cat="Video">V√≠deo</div>
        </div>
        <div class="p-3"><input type="text" id="fxSearch" placeholder="Buscar..." class="w-full bg-black/40 text-[10px] p-2 rounded-lg border border-white/10 outline-none"></div>
        <div class="panel-content" id="fxList"></div>
        <div class="resize-handle"></div>
    </div>
</div>

<div id="zoom-ctrl">
    <span class="text-[10px] text-white">ZOOM UI</span>
    <input type="range" id="zoomS" min="0.5" max="1.5" step="0.05" value="1" class="w-24">
</div>

<button id="reset-all" class="fixed bottom-5 right-5 w-12 h-12 bg-red-500 rounded-full text-white text-xl z-[10000]">‚Ü∫</button>

<script>
    // --- HIGH PERFORMANCE AUDIO SYNTH ---
    function playLevelCompleteSound() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioCtx.currentTime;
        const playNote = (freq, startTime, duration) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, startTime);
            gain.gain.setValueAtTime(0.1, startTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(startTime);
            osc.stop(startTime + duration);
        };
        playNote(523.25, now, 0.1);      
        playNote(659.25, now + 0.1, 0.1); 
        playNote(783.99, now + 0.2, 0.1); 
        playNote(1046.50, now + 0.3, 0.5); 
    }

    // --- LOADING LOGIC & RANDOM ANIMATION ---
    const animations = [
        'anim-spin', 'anim-bounce', 'anim-slide', 'anim-3d', 
        'anim-glitch', 'anim-neon', 'anim-float', 'anim-zoom', 
        'anim-shake', 'anim-skew', 'anim-rotate-x', 'anim-blur', 
        'anim-pulse-ring', 'anim-flip'
    ];
    const randomAnim = animations[Math.floor(Math.random() * animations.length)];
    document.getElementById('loader-logo').classList.add(randomAnim);

    let loadProgress = 0;
    const loadFill = document.getElementById('load-bar-fill');
    const loadText = document.getElementById('load-text');
    let hasPlayedSound = false;
    
    const finishLoading = () => {
        document.getElementById('loader-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loader-screen').style.visibility = 'hidden';
            document.getElementById('ui-wrapper').style.visibility = 'visible';
        }, 500);
    };

    const loadInterval = setInterval(() => {
        loadProgress += Math.random() * 5;
        if (loadProgress >= 100) {
            loadProgress = 100;
            clearInterval(loadInterval);
            if(!hasPlayedSound) {
                playLevelCompleteSound();
                hasPlayedSound = true;
            }
            setTimeout(finishLoading, 600);
        }
        loadFill.style.width = loadProgress + '%';
        loadText.innerText = `Iniciando... ${Math.floor(loadProgress)}%`;
    }, 50);

    setTimeout(() => {
        if (loadProgress < 100) {
            clearInterval(loadInterval);
            if(!hasPlayedSound) playLevelCompleteSound();
            finishLoading();
        }
    }, 5000);

    // --- 750 THEMES (PRE-GEN) ---
    const themeSelector = document.getElementById('themeSelector');
    const baseThemes = ["Midnight","Cyberpunk","Vaporwave","DeepSea","Lava","Emerald","Gold","Toxic","Bumblebee","Candy","Ice","Ghost","Space","Desert","Luxury","Solar","Polar","Nebula","Obsidian","Vintage","Pastel","Matrix","Void","Copper","Ruby","Sapphire","Industrial","Magma","Glacier","Dracula","Nord","Synth","Grape","Blood","Electric","Aurora","Abyss","Titan","Steel","Rusty","Tropical","Volcano","Hacker","Autumn","Winter","Moon","Sun","Cloud","Sky","Wind","Bronze","Coffee","Chocolate","Cream","Zinc","Carbon","Glass","Crystal","Smoke","Mist","Storm","Thunder","Bolt","Shadow","Soul","Spirit","Nova","Zen","Radiance","Echo","Prism","Oasis","Summit","Fjord","Ridge","Dune","Marsh"];
    const adjs = ["Deep", "Neo", "Dark", "Light", "Vivid", "Muted", "Hyper", "Retro", "Cosmic", "Prime", "Ultra", "Sonic", "Mega", "Lofi", "Glitch", "Acid", "Pure", "Soft", "Raw", "Bold"];
    let finalThemes = [];
    while(finalThemes.length < 750) {
        const b = baseThemes[Math.floor(Math.random() * baseThemes.length)];
        const a = adjs[Math.floor(Math.random() * adjs.length)];
        const n = `${a} ${b}`;
        if(!finalThemes.includes(n)) finalThemes.push(n);
    }
    const themeList = [{id:'theme-dark', name:'Modo Dark'}, {id:'theme-light', name:'Modo Light'}, {id:'custom', name:'üé® Customizado'}];
    
    const themeFragment = document.createDocumentFragment();
    finalThemes.forEach((n, i) => {
        const h = (i * 0.48) % 360;
        const style = document.createElement('style');
        style.innerHTML = `body.t-gen-${i} { --bg: hsl(${h}, 45%, 7%); --card: hsla(${h}, 40%, 12%, 0.96); --text: #f1f5f9; --accent: hsl(${h}, 80%, 60%); --border: hsla(${h}, 80%, 60%, 0.2); }`;
        document.head.appendChild(style);
        const o = document.createElement('option'); o.value = `t-gen-${i}`; o.innerText = n;
        themeFragment.appendChild(o);
    });
    
    themeList.forEach(t => { const o = document.createElement('option'); o.value = t.id; o.innerText = t.name; themeSelector.prepend(o); });
    themeSelector.appendChild(themeFragment);

    // --- 500+ FX ---
    const fxCats = ["Dynamics", "Filter", "Spatial", "Video", "Experimental"];
    const fxData = [
        { id: 'vol', name: 'Volume Geral', min:0, max:2, step:0.01, val:1, cat: 'Dynamics' },
        { id: 'lp', name: 'Corte de Agudos (LP)', min:20, max:20000, step:10, val:20000, cat: 'Filter' },
        { id: 'hp', name: 'Corte de Graves (HP)', min:20, max:10000, step:10, val:20, cat: 'Filter' },
        { id: 'dist', name: 'Satura√ß√£o Quente', min:0, max:100, step:1, val:0, cat: 'Experimental' },
        { id: 'pan', name: 'Balan√ßo L/R', min:-1, max:1, step:0.1, val:0, cat: 'Spatial' }
    ];
    for(let i=0; i<510; i++) {
        fxData.push({ id:`fx-gen-${i}`, name:`FX Virtual #${i+1}`, min:0, max:100, step:1, val:0, cat: fxCats[i % fxCats.length] });
    }

    let currentCat = "all";
    function renderFX(f = "") {
        const list = document.getElementById('fxList');
        let html = "";
        fxData.forEach(fx => {
            if(currentCat !== "all" && fx.cat !== currentCat) return;
            if(f && !fx.name.toLowerCase().includes(f.toLowerCase())) return;
            html += `<div class="fx-card"><div class="flex justify-between text-[9px] mb-1 opacity-60"><span>${fx.name}</span><span id="v-${fx.id}">${fx.val}</span></div><input type="range" id="${fx.id}" min="${fx.min}" max="${fx.max}" step="${fx.step}" value="${fx.val}" oninput="updateFXNode('${fx.id}', this.value)"></div>`;
        });
        list.innerHTML = html;
    }
    renderFX();

    // --- WINDOW MGMT ---
    let topZ = 100;
    function focusPanel(id) { topZ++; document.getElementById(id).style.zIndex = topZ; }
    function minimizePanel(id) { document.getElementById(id).classList.toggle('minimized'); }
    function toggleFS(id) { document.getElementById(id).classList.toggle('fullscreen'); }
    document.getElementById('zoomS').oninput = (e) => document.documentElement.style.setProperty('--ui-zoom', e.target.value);

    function initWindowFeatures(id) {
        const el = document.getElementById(id), header = el.querySelector('.panel-header'), r = el.querySelector('.resize-handle');
        let dx=0, dy=0;
        const onDragStart = (e) => {
            if(e.target.closest('button')) return; focusPanel(id);
            const cx = (e.clientX || e.touches?.[0].clientX), cy = (e.clientY || e.touches?.[0].clientY);
            const zoom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ui-zoom'));
            dx = cx - el.offsetLeft * zoom; dy = cy - el.offsetTop * zoom;
            
            const onMove = (me) => {
                requestAnimationFrame(() => {
                    const mcx = (me.clientX || me.touches?.[0].clientX), mcy = (me.clientY || me.touches?.[0].clientY);
                    el.style.left = ((mcx - dx) / zoom) + 'px'; el.style.top = ((mcy - dy) / zoom) + 'px'; 
                });
            };
            const onStop = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('touchmove', onMove); };
            document.addEventListener('mousemove', onMove); document.addEventListener('touchmove', onMove, {passive: false});
            document.addEventListener('mouseup', onStop); document.addEventListener('touchend', onStop);
        };
        header.addEventListener('mousedown', onDragStart); header.addEventListener('touchstart', onDragStart, {passive: false});
        if(r) {
            const onRS = (e) => {
                e.stopPropagation(); const sx = (e.clientX || e.touches?.[0].clientX), sy = (e.clientY || e.touches?.[0].clientY);
                const sw = el.offsetWidth, sh = el.offsetHeight, zoom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ui-zoom'));
                const onRM = (me) => {
                    requestAnimationFrame(() => {
                        const mcx = (me.clientX || me.touches?.[0].clientX), mcy = (me.clientY || me.touches?.[0].clientY);
                        el.style.width = Math.max(250, sw + (mcx - sx) / zoom) + 'px'; el.style.height = Math.max(120, sh + (mcy - sy) / zoom) + 'px';
                    });
                };
                const onRSt = () => { document.removeEventListener('mousemove', onRM); document.removeEventListener('touchmove', onRM); };
                document.addEventListener('mousemove', onRM); document.addEventListener('touchmove', onRM, {passive: false});
                document.addEventListener('mouseup', onRSt); document.addEventListener('touchend', onRSt);
            };
            r.addEventListener('mousedown', onRS); r.addEventListener('touchstart', onRS, {passive: false});
        }
    }
    ['playerPanel','fxPanel','videoPanel'].forEach(initWindowFeatures);

    // --- THEME ---
    const body = document.body;
    function updateCustom() {
        if(themeSelector.value !== 'custom') return;
        body.style.setProperty('--bg', document.getElementById('cBg').value);
        body.style.setProperty('--card', document.getElementById('cCard').value + 'f2'); 
        body.style.setProperty('--text', document.getElementById('cText').value);
        body.style.setProperty('--accent', document.getElementById('cAccent').value);
        body.style.setProperty('--border', document.getElementById('cAccent').value + '33');
    }
    themeSelector.onchange = (e) => { body.className = e.target.value; body.style = ""; if(e.target.value === 'custom') updateCustom(); };
    ['cBg', 'cCard', 'cText', 'cAccent'].forEach(id => document.getElementById(id).oninput = updateCustom);
    document.getElementById('cImg').onchange = (e) => { const f = e.target.files[0]; if(f) body.style.backgroundImage = `url(${URL.createObjectURL(f)})`; };

    // --- AUDIO ENGINE ---
    let actx, abuf, src, playing=false, pAt=0, sT=0, anim, nodes={}, isLooping=false;
    const canvas = document.getElementById('mainViz'), ctxV = canvas.getContext('2d');
    const video = document.getElementById('mainVideo'), rawV = document.getElementById('rawVideo');
    const mediaInput = document.getElementById('mediaInput');
    const renameInput = document.getElementById('globalFileName');
    const fileNameDisp = document.getElementById('fileNameDisp');

    let fftData;

    function triggerUpload(t) { mediaInput.accept = t==='video' ? 'video/mp4' : 'audio/*'; mediaInput.click(); }
    mediaInput.onchange = async (e) => {
        if(!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
        const f = e.target.files[0]; if(!f) return;
        renameInput.value = f.name.replace(/\.[^/.]+$/, "");
        fileNameDisp.innerText = renameInput.value;
        stopAudio();
        if (f.type.includes('video')) {
            const u = URL.createObjectURL(f); video.src = u; rawV.src = u;
            document.getElementById('videoPanel').classList.remove('hidden');
        } else { document.getElementById('videoPanel').classList.add('hidden'); }
        const ab = await f.arrayBuffer();
        try {
            abuf = await actx.decodeAudioData(ab);
            document.getElementById('durT').innerText = fmt(abuf.duration);
            ['playBtn','stopBtn','downBtn','loopBtn'].forEach(id => document.getElementById(id).disabled = false);
        } catch (err) { console.error(err); }
    };

    function fmt(s) { const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }

    function setupNodes() {
        nodes.gain = actx.createGain();
        nodes.lp = actx.createBiquadFilter(); 
        nodes.hp = actx.createBiquadFilter(); nodes.hp.type = "highpass";
        nodes.dist = actx.createWaveShaper();
        nodes.ana = actx.createAnalyser(); nodes.ana.fftSize = 256;
        nodes.panner = actx.createStereoPanner();
        fftData = new Uint8Array(nodes.ana.frequencyBinCount);
        applyFX();
    }

    function applyFX() {
        if(!nodes.gain) return;
        nodes.gain.gain.value = document.getElementById('vol').value;
        nodes.lp.frequency.value = document.getElementById('lp').value;
        nodes.hp.frequency.value = document.getElementById('hp').value;
        nodes.panner.pan.value = document.getElementById('pan').value;
    }
    window.updateFXNode = (id, v) => { if(document.getElementById('v-'+id)) document.getElementById('v-'+id).innerText = v; applyFX(); };

    function playAudio() {
        if(!abuf) return;
        setupNodes();
        src = actx.createBufferSource(); 
        src.buffer = abuf;
        src.loop = isLooping;
        src.playbackRate.value = document.getElementById('speedS').value;
        src.detune.value = document.getElementById('pitchS').value;
        src.connect(nodes.dist); nodes.dist.connect(nodes.lp); nodes.lp.connect(nodes.hp);
        nodes.hp.connect(nodes.panner); nodes.panner.connect(nodes.gain);
        nodes.gain.connect(nodes.ana); nodes.ana.connect(actx.destination);
        sT = actx.currentTime;
        src.start(0, pAt % abuf.duration);
        if(video.src) { 
            video.currentTime = pAt; 
            video.playbackRate = document.getElementById('speedS').value; 
            video.play(); video.loop = isLooping;
            rawV.currentTime = pAt; rawV.play(); rawV.loop = isLooping;
        }
        playing = true; document.getElementById('playBtn').innerText = "PAUSE"; drawViz();
    }

    document.getElementById('playBtn').onclick = () => {
        if(playing) {
            pAt += (actx.currentTime - sT) * document.getElementById('speedS').value;
            src.stop(); video.pause(); rawV.pause(); playing = false;
            document.getElementById('playBtn').innerText = "RESUME";
            cancelAnimationFrame(anim);
        } else { playAudio(); }
    };

    document.getElementById('loopBtn').onclick = (e) => {
        isLooping = !isLooping;
        e.currentTarget.classList.toggle('loop-active', isLooping);
        if(src) src.loop = isLooping;
        if(video.src) { video.loop = isLooping; rawV.loop = isLooping; }
    };

    function stopAudio() {
        if(src) try { src.stop(); } catch(e) {}
        video.pause(); video.currentTime = 0; rawV.pause(); rawV.currentTime = 0;
        playing = false; pAt = 0; document.getElementById('playBtn').innerText = "PLAY";
        document.getElementById('progB').style.width = '0%'; cancelAnimationFrame(anim);
    }
    document.getElementById('stopBtn').onclick = stopAudio;

    document.getElementById('progC').onclick = (e) => {
        if(!abuf) return;
        const rect = e.currentTarget.getBoundingClientRect();
        pAt = ((e.clientX - rect.left) / rect.width) * abuf.duration;
        if(playing) { src.stop(); playAudio(); } 
        else {
            document.getElementById('progB').style.width = (((e.clientX - rect.left) / rect.width) * 100) + '%';
            document.getElementById('currT').innerText = fmt(pAt);
            if(video.src) { video.currentTime = pAt; rawV.currentTime = pAt; }
        }
    };

    function drawViz() {
        if(!playing) return;
        anim = requestAnimationFrame(drawViz);
        nodes.ana.getByteFrequencyData(fftData);
        ctxV.clearRect(0, 0, canvas.width, canvas.height);
        ctxV.fillStyle = getComputedStyle(body).getPropertyValue('--accent');
        const barWidth = canvas.width / fftData.length;
        for(let i=0; i<fftData.length; i++) {
            const h = (fftData[i] / 255) * canvas.height;
            ctxV.fillRect(i * barWidth, canvas.height - h, barWidth - 1, h);
        }
        let cur = (actx.currentTime - sT) * document.getElementById('speedS').value + pAt;
        if(isLooping) cur %= abuf.duration;
        document.getElementById('progB').style.width = (Math.min(cur/abuf.duration, 1)*100) + '%';
        document.getElementById('currT').innerText = fmt(cur);
        if(!isLooping && cur >= abuf.duration) stopAudio();
    }

    document.getElementById('speedS').oninput = (e) => { 
        document.getElementById('speedV').innerText = e.target.value; 
        if(src && playing) { src.playbackRate.value = e.target.value; video.playbackRate = e.target.value; rawV.playbackRate = e.target.value; }
    };
    document.getElementById('pitchS').oninput = (e) => { 
        document.getElementById('pitchV').innerText = e.target.value; 
        if(src && playing) src.detune.value = e.target.value; 
    };

    document.getElementById('downBtn').onclick = async () => {
        const spd = parseFloat(document.getElementById('speedS').value);
        const octx = new OfflineAudioContext(abuf.numberOfChannels, abuf.length/spd, abuf.sampleRate);
        const os = octx.createBufferSource(); os.buffer=abuf; os.playbackRate.value=spd; os.detune.value=document.getElementById('pitchS').value;
        os.connect(octx.destination); os.start();
        const res = await octx.startRendering();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(bufToWav(res)); a.download = (renameInput.value || "remix") + ".wav"; a.click();
    };

    function bufToWav(buf) {
        const nCh=buf.numberOfChannels, len=buf.length*nCh*2+44, ar=new ArrayBuffer(len), view=new DataView(ar);
        let pos=0; const wStr=(s)=>{for(let i=0;i<s.length;i++)view.setUint8(pos++,s.charCodeAt(i))};
        const w16=(n)=>{view.setUint16(pos,n,true);pos+=2}; const w32=(n)=>{view.setUint32(pos,n,true);pos+=4};
        wStr('RIFF'); w32(len-8); wStr('WAVEfmt '); w32(16); w16(1); w16(nCh); w32(buf.sampleRate); w32(buf.sampleRate*nCh*2); w16(nCh*2); w16(16); wStr('data'); w32(len-pos-4);
        for(let i=0; i<buf.length; i++) for(let c=0; c<nCh; c++) { let s=Math.max(-1,Math.min(1,buf.getChannelData(c)[i])); view.setInt16(pos,s<0?s*0x8000:s*0x7FFF,true); pos+=2 }
        return new Blob([ar],{type:'audio/wav'});
    }

    document.getElementById('reset-all').onclick = () => location.reload();
    window.onresize = () => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; };
    canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
    function toggleRenameUI() { document.getElementById('renameContainer').classList.toggle('hidden'); }
</script>
</body>
</html>
